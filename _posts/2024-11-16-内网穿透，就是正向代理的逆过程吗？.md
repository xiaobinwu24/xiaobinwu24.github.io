---
layout: post
title:  "内网穿透，就是正向代理的逆过程吗？"
date:   2024-11-17 23:05:41 +0800
categories: 计算机网络
tags: [计算机网络]
---
![描述图片](/asset/img/1.png)
<audio controls autoplay>
  <source src="/asset/mp3/a2.mp3" type="audio/mpeg">
</audio>

从操作方向来看，**内网穿透确实可以被理解为“正向代理的反向操作”**，但两者的实现机制和具体用途略有不同。以下从概念、机制和用途上比较它们，以帮助更清晰地理解这个问题。

### **1. 正向代理 vs. 反向代理**

#### **1.1 正向代理**

*   **定义**：

    *   正向代理是客户端主动请求代理服务器，由代理服务器替客户端访问目标资源。
    *   客户端知道代理服务器的存在，但目标服务器并不知道请求来自哪个具体的客户端。
*   **工作流程**：

    1.  客户端向代理服务器发起请求。
    2.  代理服务器代替客户端访问目标服务器，获取资源后返回给客户端。
*   **用途**：

    *   访问受限资源（如翻墙）。
    *   隐藏客户端的真实IP地址。
    *   缓存和加速资源访问。

#### **1.2 反向代理**

*   **定义**：

    *   反向代理是目标服务器在其前端部署的代理服务器，代理服务器负责接收客户端请求并将其转发到后端服务器。
    *   客户端并不知道真正的目标服务器地址，只与反向代理服务器交互。
*   **工作流程**：

    1.  客户端向反向代理服务器发起请求。
    2.  反向代理根据请求内容，选择合适的后端服务器处理请求。
    3.  后端服务器的响应通过反向代理返回给客户端。
*   **用途**：

    *   隐藏后端服务器的真实地址。
    *   提供负载均衡和高可用性。
    *   实现缓存、SSL终结等功能。

### **2. 内网穿透与正向代理/反向代理的对比**

| **特性**      | **正向代理**              | **反向代理**            | **内网穿透**             |
| :---------- | :-------------------- | :------------------ | :------------------- |
| **谁发起请求**   | 客户端发起请求，通过代理访问目标资源    | 客户端请求反向代理，由代理访问后端资源 | 内网客户端主动连接中继服务器，建立长连接 |
| **隐藏的对象**   | 隐藏客户端                 | 隐藏服务器               | 将内网服务暴露到公网           |
| **面向对象**    | 客户端                   | 服务器                 | 内网服务（主机）             |
| **数据流方向**   | 从客户端到外部资源             | 从客户端到内网服务           | 从外网用户到内网服务           |
| **核心目的**    | 代理客户端访问受限资源           | 提供对后端服务的访问          | 实现外网用户访问内网服务         |
| **常见工具/协议** | Squid、Shadowsocks、VPN | Nginx、HAProxy       | ngrok、FRP、ZeroTier   |

### **3. 内网穿透如何像反向的正向代理？**

#### **正向代理的反向特点**

1.  **正向代理的视角**：

    *   客户端是发起者，主动请求代理服务器。
    *   代理服务器对客户端透明，对目标服务器隐藏客户端。
2.  **内网穿透的视角（类似反向正向代理）**：

    *   内网设备（服务端）主动连接中继服务器，建立反向的长连接。
    *   外部用户通过中继服务器访问内网服务，而无需了解内网的真实地址。

#### **数据流的反向性**

*   **正向代理**：客户端主动发起流量，从客户端→代理→目标资源。
*   **内网穿透**：客户端的“反向”流量是从外网用户→中继服务器→内网服务。

### **4. 实现差异：为什么内网穿透不仅是反向操作？**

尽管内网穿透看似是正向代理的反向过程，但它需要额外处理以下问题：

#### **4.1 穿越NAT和防火墙**

*   正向代理通常在公网环境中，客户端可以直接访问代理服务器。
*   内网穿透需要绕过NAT和防火墙的限制：

    *   内网客户端主动连接中继服务器，建立反向隧道。
    *   外网用户通过中继服务器访问内网资源。

#### **4.2 长连接的维持**

*   内网穿透工具需要维持客户端与中继服务器之间的长连接，以便随时转发外部请求。
*   这是正向代理不需要的额外功能。

#### **4.3 动态公网地址的分配**

*   内网穿透需要中继服务器为每个内网服务动态分配公网地址或域名，方便外网用户访问。
*   正向代理通常只需一个固定的出口IP即可满足需求。
*

### **5. 示例对比**

#### **正向代理的示例**

用户在内网中使用正向代理服务器访问外部网站：

1.  客户端：`内网地址（192.168.1.10）`
2.  代理服务器：`公网地址（8.8.8.8）`
3.  流程：

    *   客户端请求代理服务器（`http://8.8.8.8`）。
    *   代理服务器访问目标网站（如 `https://google.com`）。
    *   网站返回内容至代理服务器，代理服务器再返回至客户端。

#### **内网穿透的示例**

用户通过内网穿透工具（如 ngrok）访问位于内网的服务：

1.  内网服务：`http://192.168.1.10:8080`
2.  中继服务器：`ngrok 公网地址（https://abcd1234.ngrok.io）`
3.  流程：

    *   内网服务主动连接 ngrok 的中继服务器。
    *   中继服务器为内网服务生成公网地址（如 `https://abcd1234.ngrok.io`）。
    *   外部用户访问 `https://abcd1234.ngrok.io`，请求转发到内网服务。

### **6. 总结：内网穿透是否是反向的正向代理？**

*   **从数据流方向看**：内网穿透确实是类似于正向代理的反向操作。
*   **从技术实现看**：内网穿透需要解决NAT穿越、长连接维护、公网地址映射等额外问题，因此比单纯的反向操作复杂得多。

